name: 每日定时选股

on:
  # 允许在 GitHub Actions 页面手动触发此工作流
  workflow_dispatch:
  
  # 定时触发
  schedule:
    # CRON 表达式，代表在 UTC 时间的周一至周五的 1:35 执行。
    # 这对应于北京时间 (UTC+8) 的上午 9:35。
    - cron: '35 1 * * 1-5'

jobs:
  run-scheduled-selection:
    runs-on: ubuntu-latest
    
    steps:
      # 第一步：检出仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：设置 Python 环境
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 第三步：从源码编译并安装 TA-Lib
      - name: Build and Install TA-Lib from Source
        run: |
          # 安装编译所需的依赖
          sudo apt-get update
          sudo apt-get install -y wget build-essential
          # 下载 TA-Lib 源码
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          # 解压并安装
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install

      # 第四步：安装 Python 依赖
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 第五步：运行选股脚本 (使用功能更强的 comprehensive 策略)
      - name: Run stock selection script
        run: python main.py select --strategy comprehensive

      # 第六步：自动提交结果文件
      - name: Commit and push results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat(automation): 自动更新每日选股结果"
          commit_options: '--no-verify'
          # 指定要提交的文件在哪个目录
          file_pattern: 'results/*.json'
          repository: .
          # 配置提交者信息
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
          commit_author: GitHub Actions Bot <actions@github.com> 